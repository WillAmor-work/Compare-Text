USE EMEABB;
GO

IF EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = N'Conv_DY_MAJ_Normalised' AND TABLE_TYPE = N'BASE TABLE')
  DROP TABLE Conv_DY_MAJ_Normalised;
GO

select
  c.CASE_REF,
  ce.MAJ_TEXT3,
  ce.MAJ_DON,
  ce.MAJ_TRK_ID,
  t.TRK_TXT1,
  ce.MAJ_TRK_STEP_COMP1,
  t.TRK_TXT2,
  ce.MAJ_TRK_STEP_COMP2,
  t.TRK_TXT3,
  ce.MAJ_TRK_STEP_COMP3,
  t.TRK_TXT4,
  ce.MAJ_TRK_STEP_COMP4,
  t.TRK_TXT5,
  ce.MAJ_TRK_STEP_COMP5,
  t.TRK_TXT6,
  ce.MAJ_TRK_STEP_COMP6,
  t.TRK_TXT7,
  ce.MAJ_TRK_STEP_COMP7,
  t.TRK_TXT8,
  ce.MAJ_TRK_STEP_COMP8,
  t.TRK_TXT9,
  ce.MAJ_TRK_STEP_COMP9,
  t.TRK_TXT10,
  ce.MAJ_TRK_STEP_COMP10,
  'MAJ_OA_Date' as OA_Date,
  ce.MAJ_OA_DATE,
  'MAJ_OA_Received' as OA_Received,
  ce.MAJ_OA_RECEIVED,
  c2.COUNTRY_CODE,
	c.APPS_CASE_TYPE,
	c.IC_CODE,
	ce.MAJ_SEQ,
	LTRIM(RTRIM(ce.MAJ_TEXT3))+
	CASE WHEN ce.MAJ_TEXT1 != '' THEN CHAR(13)+CHAR(10)+LTRIM(RTRIM(ce.MAJ_TEXT1)) ELSE '' END+
	CASE WHEN ce.MAJ_TEXT2 != '' THEN CHAR(13)+CHAR(10)+LTRIM(RTRIM(ce.MAJ_TEXT2)) ELSE '' END+
	CASE WHEN ce.MAJ_TEXT4 != '' THEN CHAR(13)+CHAR(10)+LTRIM(RTRIM(ce.MAJ_TEXT4)) ELSE '' END as NOTES
into #temp_event_extract
from
  BB..APPSALL c
  join BB..APPSALL2 c2 on c2.CASE_REF = c.CASE_REF
  join BB..DY_MAJ ce on ce.MAJ_CASE_REF = c.CASE_REF
  join BB..TRACKS t on t.TRK_ID = ce.MAJ_TRK_ID
where
  ce.MAJ_TYPE != 'K'
--  c.APPS_CASE_TYPE = 'P'
--  and c2.COUNTRY_CODE = 'EP'

--select * from #temp_event_extract

--drop table conv_DY_MAJ_Normalised

--drop table #temp_caseevents
--select CASE_REF, COUNTRY_CODE, MAJ_TEXT3 as [eventdesc], MAJ_DON as [eventdate] into #temp_caseevents from #temp_event_extract where MAJ_DON is not null
--union
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT1)) as [eventdesc], MAJ_TRK_STEP_COMP1 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT1)) as TRK_TXT, MAJ_SEQ, MAJ_DON
into Conv_DY_MAJ_Normalised 
from #temp_event_extract where MAJ_TRK_STEP_COMP1 is not null
union																																																    
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT2)) as [eventdesc], MAJ_TRK_STEP_COMP2 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT2)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP2 is not null
union																																																    																											 					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT3)) as [eventdesc], MAJ_TRK_STEP_COMP3 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT3)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP3 is not null
union																																																     																											 					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT4)) as [eventdesc], MAJ_TRK_STEP_COMP4 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT4)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP4 is not null
union																																																    																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT5)) as [eventdesc], MAJ_TRK_STEP_COMP5 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT5)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP5 is not null
union																																																    																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT6)) as [eventdesc], MAJ_TRK_STEP_COMP6 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT6)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP6 is not null
union																																																    																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT7)) as [eventdesc], MAJ_TRK_STEP_COMP7 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT7)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP7 is not null
union																																																    																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT8)) as [eventdesc], MAJ_TRK_STEP_COMP8 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT8)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP8 is not null
union																																																     																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT9)) as [eventdesc], MAJ_TRK_STEP_COMP9 as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT9)) as TRK_TXT, MAJ_SEQ, MAJ_DON   from #temp_event_extract where MAJ_TRK_STEP_COMP9 is not null
union																																																    																											  					
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3)) + ': ' + LTRIM(RTRIM(TRK_TXT10)) as [eventdesc], MAJ_TRK_STEP_COMP10 as [eventdate], APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, LTRIM(RTRIM(TRK_TXT10)) as TRK_TXT, MAJ_SEQ, MAJ_DON  from #temp_event_extract where MAJ_TRK_STEP_COMP10 is not null
union																																																     
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3))+ ' {OA_Date}' as [eventdesc], MAJ_OA_DATE as [eventdate]  , APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, '{OA_Date}' as TRK_TXT, MAJ_SEQ, MAJ_DON  from #temp_event_extract where MAJ_OA_DATE is not null
union																																																    
select LTRIM(RTRIM(CASE_REF)) as [CASE_REF], LTRIM(RTRIM(COUNTRY_CODE)) as [COUNTRY_CODE], LTRIM(RTRIM(MAJ_TRK_ID)) as [MAJ_TRK_ID], LTRIM(RTRIM(MAJ_TEXT3))+ ' {OA_Received}' as [eventdesc], MAJ_OA_RECEIVED as [eventdate], APPS_CASE_TYPE,IC_CODE, NOTES, LTRIM(RTRIM(MAJ_TEXT3)) as MAJ_TEXT3, '{OA_Received}' as TRK_TXT, MAJ_SEQ, MAJ_DON  from #temp_event_extract where MAJ_OA_RECEIVED is not null
order by 3


--select * from conv_DY_MAJ_Normalised where CASE_REF = 'P089648.EPP'

--select * from BB..DY_MAJ where MAJ_CASE_REF = 'P089648.EPP'
--select * from BB..TRACKS where TRK_ID = 'FEPPCT'

/*
--MAPPING DOC
select
	--distinct -- 145800
	APPS_CASE_TYPE,
	IC_CODE,
	MAJ_TRK_ID,
	COUNTRY_CODE,
	[eventdesc]
	,count(*) as [Count]
from
	conv_DY_MAJ_Normalised
Where
	APPS_CASE_TYPE = 'P'
    and
	(eventdesc like '%{OA_Date}' or eventdesc like '%{OA_Received}')
group by 
	APPS_CASE_TYPE,
	IC_CODE,
	MAJ_TRK_ID,
	COUNTRY_CODE,
	[eventdesc]
order by 4,1,2
*/

--select * from BB..DY_MAJ



