/*******************************************************************************

                            CPA Software Solutions
                      

							Barker Brettell LLP


Description:
Import Case Names from Progressor to Inprotech database

Modification History:
19/01/2023		Created						D Hodges


*******************************************************************************/
use EMEABB
go

set concat_null_yields_null off
go


DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names',
                                     N'Insert CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT


insert into CASENAME(CASEID, NAMETYPE, SEQUENCE, NAMENO, INHERITED, CORRESPONDNAME, DERIVEDCORRNAME, REFERENCENO, ADDRESSCODE)
select 
	cmc.CASEID,
	ntm.NAMETYPE,
	row_number() over (partition by cmc.CASEID, ntm.NAMETYPE order by c.SN_CCD_CODE )-1 as SEQUENCE,
	cn.NAMENO,
	0 as INHERITED,
	CASE WHEN ntm.NAMETYPE = 'I' THEN mcn.NAMENO ELSE NULL END as CORRESPONDNAME,
	0 as DERIVEDCORRNAME,
	null as REFERENCENO,
	cn.ADDRESSCODE
from
	Conv_MappingCases cmc
	join BB..SN_CCD c on c.CASE_REF COLLATE DATABASE_DEFAULT = cmc.BB_CASE_REF
	join Conv_NAME cn on cn.NA_REFERENCE = c.SN_CCD_CODE COLLATE DATABASE_DEFAULT
	join Conv_NAMETYPEMAP ntm on ntm.BB_NAMETYPE = c.SN_CCD_TYPE  COLLATE DATABASE_DEFAULT --801627
	left join BB..SN_CCD mc on mc.CASE_REF COLLATE DATABASE_DEFAULT = cmc.BB_CASE_REF and mc.SN_CCD_TYPE = 'CLI M.C.'
	left join Conv_NAME mcn on mcn.NA_REFERENCE = mc.SN_CCD_CODE COLLATE DATABASE_DEFAULT
--select * from BB..SN_CCTP has ordering by property type?


SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go

DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names - BillPercentage for Debtors',
                                     N'Update CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT

update casename 
set BILLPERCENTAGE = 100.00
where nametype in ('D', 'Z') 
and SEQUENCE = 0

SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go


DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names - PARTNERS',
                                     N'Insert CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT

insert into CASENAME(CASEID, NAMETYPE, SEQUENCE, NAMENO, INHERITED, CORRESPONDNAME, DERIVEDCORRNAME, REFERENCENO, ADDRESSCODE)
select 
	cmc.CASEID,
	'EMP',
	row_number() over (partition by cmc.CASEID order by p.NAMENO )-1 as SEQUENCE,
	p.NAMENO,
	0 as INHERITED,
	null as CORRESPONDNAME,
	0 as DERIVEDCORRNAME,
	null as REFERENCENO,
	p.ADDRESSCODE
from 
	Conv_MappingCases cmc
	join BB..APPSALL a on cmc.BB_CASE_REF = a.CASE_REF COLLATE DATABASE_DEFAULT
	join Conv_NAME p on a.CSE_PARTNER COLLATE DATABASE_DEFAULT = p.NAMECODE

SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go

DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names - PARTNERS SIG',
                                     N'Insert CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT

insert into CASENAME(CASEID, NAMETYPE, SEQUENCE, NAMENO, INHERITED, CORRESPONDNAME, DERIVEDCORRNAME, REFERENCENO, ADDRESSCODE)
select 
	cmc.CASEID,
	'SIG',
	row_number() over (partition by cmc.CASEID order by p.NAMENO )-1 as SEQUENCE,
	p.NAMENO,
	0 as INHERITED,
	null as CORRESPONDNAME,
	0 as DERIVEDCORRNAME,
	null as REFERENCENO,
	p.ADDRESSCODE
from 
	Conv_MappingCases cmc
	join BB..APPSALL a on cmc.BB_CASE_REF = a.CASE_REF COLLATE DATABASE_DEFAULT
	join Conv_NAME p on a.CSE_PARTNER COLLATE DATABASE_DEFAULT = p.NAMECODE

SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go



DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names - Renewals Team (ZS) Names',
                                     N'Insert CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT

insert into CASENAME(CASEID, NAMETYPE, SEQUENCE, NAMENO, INHERITED, CORRESPONDNAME, DERIVEDCORRNAME, REFERENCENO, ADDRESSCODE)
select 
	cmc.CASEID,
	'ZS',
	0 as SEQUENCE,
	CASE when cmc.PROPERTYTYPE = 'T' then 537
		 when cmc.PROPERTYTYPE in ('P','D', 'U') then 538 --added 'U' here cut5 25/07/2023 wda
	end as NAMENO,
	0 as INHERITED,
	null as CORRESPONDNAME,
	0 as DERIVEDCORRNAME,
	null as REFERENCENO,
	501
from 
	Conv_MappingCases cmc



SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go

--select * from Conv_MappingCases where PROPERTYTYPE not in ('P','D','T')
--select * from NAMETYPE
--select * from NAME where name like '%renewal%'


DECLARE @LogID        int,
        @RowsAffected bigint,
        @Error        int

EXECUTE [dbo].[cpass_conv_Log_Start] NULL,
                                     N'201 - CaseNames',
                                     NULL,
                                     N'Case Names - CORRES REF: Instructor reference',
                                     N'UPDATE CASENAME',
                                     N'CASENAME',
                                     1,
                                     @LogID OUTPUT

  UPDATE cn
  set REFERENCENO = e.CASE_EXT_DATA
  from 
	BB..CASE_EXT e
	join Conv_MappingCases cmc on e.CASE_REF COLLATE DATABASE_DEFAULT = cmc.BB_CASE_REF
	join CASENAME cn on cn.CASEID = cmc.CASEID and cn.NAMETYPE = 'I'
  where 
	e.CASE_EXT_KEY = 'CORRES REF'
	and e.CASE_EXT_DATA != ''
 -- CASE_EXT_KEY = 'PO NUMBER'                                                

SELECT @Error        = @@ERROR,
       @RowsAffected = @@ROWCOUNT

EXECUTE [dbo].[cpass_conv_Log_End] @LogID,
                                   @RowsAffected,
                                   @Error,
                                   1
go
